<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selvskade ‚Äì Tr√∏st Mig</title>
  <link rel="stylesheet" href="style.css">
  <script src="tts-config.js"></script>
  <style>
  body, html { height: 100%; margin: 0; font-family: 'San Francisco', 'Segoe UI', 'Arial', sans-serif; background: #f6f7fa; }
  .bg-video { position: fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-1; }
  .main-selection { display: flex; flex-direction: column; align-items: center; margin-top: 3.5rem; }
  .selection-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap: 36px; width: 100%; max-width: 900px; }
  .selection-card { background: rgba(255,255,255,0.92); border-radius: 22px; box-shadow: 0 8px 32px rgba(0,0,0,0.13), 0 1.5px 4px rgba(0,0,0,0.07); padding: 2.2rem 1.5rem; cursor: pointer; transition: box-shadow .2s; display: flex; flex-direction: column; align-items: center; }
  .selection-card:hover { box-shadow: 0 12px 32px rgba(0,0,0,0.16); }
  .selection-icon { font-size: 2.4rem; margin-bottom: 0.7rem; }
  .script-text { margin: 3.5rem auto 0 auto; max-width: 600px; font-size: 1.25rem; background: rgba(255,255,255,0.97); border-radius: 26px; padding: 2.5rem 2.2rem 2.2rem 2.2rem; min-height: 120px; box-shadow: 0 8px 32px rgba(0,0,0,0.13), 0 1.5px 4px rgba(0,0,0,0.07); display: flex; flex-direction: column; align-items: center; }
  .choices { margin-top: 2.2rem; display: flex; flex-direction: column; gap: 1.2rem; width: 100%; align-items: center; }
  .choice-btn { font-size: 1.13rem; padding: 0.9rem 2.2rem; border-radius: 16px; border: none; background: linear-gradient(180deg, #f7f7fa 80%, #e6e6ef 100%); box-shadow: 0 2px 8px rgba(0,0,0,0.07); color: #222; cursor: pointer; transition: background .2s, box-shadow .2s; outline: none; font-family: inherit; }
  .choice-btn:hover, .choice-btn:focus { background: #f0f0f7; box-shadow: 0 4px 16px rgba(0,0,0,0.11); }
  #playerControls { display: flex; gap: 1.5rem; justify-content: center; margin: 2.5rem auto 0 auto; background: none; box-shadow: none; border-radius: 0; padding: 0; max-width: 600px; }
  #favBtn.active { color: #e74c3c; }
  #pauseBtn, #stopBtn, #favBtn { background: linear-gradient(180deg, #f7f7fa 80%, #e6e6ef 100%); border: none; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 0.7rem 1.5rem; font-size: 1.1rem; color: #222; margin: 0 0.3rem; font-family: inherit; cursor: pointer; transition: background .2s, box-shadow .2s; outline: none; }
  #pauseBtn:hover, #stopBtn:hover, #favBtn:hover, #pauseBtn:focus, #stopBtn:focus, #favBtn:focus { background: #f0f0f7; box-shadow: 0 4px 16px rgba(0,0,0,0.11); }
  #voiceSelector, #navVoiceSelector { border-radius: 10px; border: 1px solid #e0e0e0; padding: 0.5rem 1rem; font-size: 1.05rem; background: #f7f7fa; box-shadow: 0 1px 4px rgba(0,0,0,0.04); margin-left: 0.5rem; }
  .soft-question { font-size: 1.25rem; font-weight: 500; margin-bottom: 1.5rem; text-align: center; color: #222; font-family: inherit; }
  #backToCategoriesBtn { background: linear-gradient(180deg, #fff 80%, #f7f7fa 100%); border-radius: 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.13); font-size: 1.1rem; padding: 12px 36px; }

  /* --- Fullscreen script mode --- */
  body.fullscreen-script {
    overflow: hidden;
    background: #000;
  }
  body.fullscreen-script .main-selection,
  body.fullscreen-script #mainNav {
    display: none !important;
  }
  body.fullscreen-script .script-text,
  body.fullscreen-script #playerControls,
  body.fullscreen-script #backToCategoriesBtn {
    z-index: 10;
    position: relative;
  }
  body.fullscreen-script .bg-video {
    filter: brightness(0.7) blur(0.5px);
  }
  #mainNav { position: sticky; top: 0; left: 0; width: 100vw; background: rgba(255,255,255,0.92); box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 1.2rem; padding: 0.7rem 2.2vw; z-index: 20; }
  #mainNav a { color: #222; text-decoration: none; font-weight: 500; font-size: 1.13rem; margin: 0 0.5rem; transition: color .2s; }
  #mainNav a:hover { color: #4b6cb7; }
  #mainNav #themeToggle { margin-right: 0.7rem; }
  </style>
</head>
<body>
  <video id="bgVideo" class="bg-video" src="din-video.mp4" autoplay loop muted playsinline></video>
  <audio id="audioTrack" src="audio1.mp3" loop></audio>
  <nav id="mainNav">
    <span id="navIndicator"></span>
    <button id="themeToggle">üåô</button>
    <select id="navVoiceSelector"></select>
    <a href="index.html">Hjem</a>
    <a href="playlists.html">Favoritter</a>
  </nav>
  <div class="main-selection" id="mainSelection">
    <div class="selection-header">
      <h1>Selvskade</h1>
      <p>V√¶lg et fokusomr√•de, eller tag hele rejsen.</p>
    </div>
    <div class="selection-grid">
      <div class="selection-card" data-category="forsta">
        <div class="selection-icon">üß†</div>
        <h2>Forst√•else</h2>
        <p>Hvorfor opst√•r selvskade? F√• viden og indsigt.</p>
      </div>
      <div class="selection-card" data-category="strategier">
        <div class="selection-icon">üõ†Ô∏è</div>
        <h2>Strategier</h2>
        <p>Praktiske metoder til at h√•ndtere trangen.</p>
      </div>
      <div class="selection-card" data-category="refleksion">
        <div class="selection-icon">üí¨</div>
        <h2>Refleksion</h2>
        <p>Udforsk dine f√∏lelser og situationer med guidede sp√∏rgsm√•l.</p>
      </div>
    </div>
  </div>
  <div class="script-text" id="scriptText" style="display:none;"></div>
  <div id="playerControls" style="display:none;">
    <button id="pauseBtn">‚è∏Ô∏è</button>
    <button id="stopBtn">‚èπÔ∏è</button>
    <button id="favBtn">‚òÖ</button>
    <select id="voiceSelector"></select>
  </div>
  <button id="backToCategoriesBtn" style="display:none;position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:10;padding:10px 24px;border-radius:16px;background:#fff;color:#222;font-size:1rem;border:none;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;">‚Üê Tilbage til kategorier</button>
  <script>
    // --- Modul√¶rt sp√∏rgesystem ---
    const categoryModules = {
      forsta: [
        { id: 'f1', text: "Hvad tror du selvskade handler om for dig?", choices: [
          { label: "At f√• kontrol", next: 'f2' },
          { label: "At slippe for f√∏lelser", next: 'f3' },
          { label: "Noget andet", next: 'f4' }
        ] },
        { id: 'f2', text: "Mange oplever at selvskade giver en f√∏lelse af kontrol. Hvad kunne du g√∏re i stedet for at opn√• kontrol?", choices: [
          { label: "Tale med nogen", next: 'f5' },
          { label: "Skrive tanker ned", next: 'f5' }
        ] },
        { id: 'f3', text: "At slippe for f√∏lelser kan f√∏les som en lettelse. Kan du finde andre m√•der at give dig selv ro p√•?", next: 'f5' },
        { id: 'f4', text: "Det er vigtigt at v√¶re nysgerrig p√• dine egne grunde. Vil du pr√∏ve at skrive dem ned?", next: 'f5' },
        { id: 'f5', text: "Tak fordi du deler. Husk, du er ikke alene. Vil du pr√∏ve en strategi?", next: null }
      ],
      strategier: [
        { id: 's1', text: "N√•r trangen opst√•r, hvad vil du helst pr√∏ve?", choices: [
          { label: "Aflede mig selv", next: 's2' },
          { label: "Tr√¶kke vejret dybt", next: 's3' },
          { label: "Skrive tanker ned", next: 's4' }
        ] },
        { id: 's2', text: "Afledning kan v√¶re at g√• en tur, h√∏re musik eller ringe til en ven. Hvad vil du v√¶lge?", next: 's5' },
        { id: 's3', text: "Pr√∏v at tage 5 dybe vejrtr√¶kninger. Hvordan f√∏les det bagefter?", next: 's5' },
        { id: 's4', text: "At skrive tanker ned kan give overblik. Vil du pr√∏ve det n√¶ste gang?", next: 's5' },
        { id: 's5', text: "Godt g√•et! Hver gang du v√¶lger omsorg, styrker du dig selv.", next: null }
      ],
      refleksion: [
        { id: 'r1', text: "Hvilken f√∏lelse fylder mest, n√•r du f√•r trang?", choices: [
          { label: "Overv√¶ldelse", next: 'r2' },
          { label: "Tomhed", next: 'r3' },
          { label: "Skyld/skam", next: 'r4' }
        ] },
        { id: 'r2', text: "N√•r du er overv√¶ldet, kan det hj√¶lpe at s√¶tte ord p√• f√∏lelsen. Vil du pr√∏ve at skrive ned, hvad der sker i dig?", next: 'r5' },
        { id: 'r3', text: "Tomhed kan v√¶re sv√¶r. Pr√∏v at lave noget sanseligt: lyt til musik, tag et bad, g√• en tur.", next: 'r5' },
        { id: 'r4', text: "Skyld og skam er tunge f√∏lelser. Husk: Du fortjener omsorg. Pr√∏v at tale til dig selv som til en ven.", next: 'r5' },
        { id: 'r5', text: "Du er i gang med en proces. Hver gang du √∏ver, skaber du nye forbindelser i hjernen.", next: null }
      ]
    };
    let currentCategory = null;
    let currentModule = null;
    let isPaused = false;
    let ttsUtterance = null;
    let ttsActive = false;
    let moduleTimeout = null;
    // DOM elements
    const bgVideo = document.getElementById('bgVideo');
    const scriptText = document.getElementById('scriptText');
    const playerControls = document.getElementById('playerControls');
    const stopBtn = document.getElementById('stopBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const favBtn = document.getElementById('favBtn');
    const audioTrack = document.getElementById('audioTrack');
    const voiceSelector = document.getElementById('voiceSelector');
    // --- Favorit system ---
    function getFavorites() {
      return JSON.parse(localStorage.getItem('trostmig_favorites') || '[]');
    }
    function setFavorite(id) {
      let favs = getFavorites();
      if (!favs.includes(id)) favs.push(id);
      localStorage.setItem('trostmig_favorites', JSON.stringify(favs));
      favBtn.classList.add('active');
    }
    function removeFavorite(id) {
      let favs = getFavorites();
      favs = favs.filter(f => f !== id);
      localStorage.setItem('trostmig_favorites', JSON.stringify(favs));
      favBtn.classList.remove('active');
    }
    function updateFavBtn() {
      const favs = getFavorites();
      favBtn.classList.toggle('active', favs.includes('selvskade'));
    }
    favBtn.onclick = () => {
      const favs = getFavorites();
      if (favs.includes('selvskade')) removeFavorite('selvskade');
      else setFavorite('selvskade');
    };
    // --- Kategori-menu klik ---
    document.querySelectorAll('.selection-card').forEach(card => {
      card.onclick = function() {
        startCategory(this.getAttribute('data-category'));
      };
    });
    function startCategory(category) {
      currentCategory = category;
      document.getElementById('mainSelection').style.display = 'none';
      scriptText.style.display = 'flex';
      playerControls.style.display = 'flex';
      document.getElementById('backToCategoriesBtn').style.display = 'block';
      document.body.classList.add('fullscreen-script');
      // Find f√∏rste modul (id ender p√• 1)
      const first = categoryModules[category].find(m => m.id.endsWith('1')) || categoryModules[category][0];
      showModule(first);
      updateFavBtn();
    }
    document.getElementById('backToCategoriesBtn').onclick = function() {
      scriptText.style.display = 'none';
      playerControls.style.display = 'none';
      this.style.display = 'none';
      document.getElementById('mainSelection').style.display = 'block';
      document.body.classList.remove('fullscreen-script');
      stopAll();
    };
  body.fullscreen-script {
    overflow: hidden;
    background: #000;
  }
  body.fullscreen-script .main-selection, body.fullscreen-script #mainNav {
    display: none !important;
  }
  body.fullscreen-script .script-text, body.fullscreen-script #playerControls, body.fullscreen-script #backToCategoriesBtn {
    z-index: 10;
    position: relative;
  }
  body.fullscreen-script .bg-video {
    filter: brightness(0.7) blur(0.5px);
  }
    function showModule(module) {
      currentModule = module;
      scriptText.innerHTML = `<div class="soft-question">${module.text}</div>`;
      // Remove any previous choices
      const oldChoices = scriptText.querySelector('.choices');
      if (oldChoices) oldChoices.remove();
      // Play TTS and only show choices or advance after TTS is done
      playTTS(module.text, () => {
        if (module.choices) {
          const choicesDiv = document.createElement('div');
          choicesDiv.className = 'choices';
          module.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = choice.label;
            btn.onclick = (e) => {
              e.stopPropagation();
              showModule(categoryModules[currentCategory].find(m => m.id === choice.next));
            };
            choicesDiv.appendChild(btn);
          });
          scriptText.appendChild(choicesDiv);
        } else if (module.next && !isPaused) {
          showModule(categoryModules[currentCategory].find(m => m.id === module.next));
        }
      });
    }
    function playTTS(text, onEnd) {
      stopTTS();
      let voiceName = voiceSelector.value;
      // Brug Tr√∏stMigTTS hvis muligt
      if (window.Tr√∏stMigTTS && typeof window.Tr√∏stMigTTS.speak === 'function') {
        ttsActive = true;
        window.Tr√∏stMigTTS.speak(text, {
          voice: voiceName,
          lang: 'da-DK',
          onend: () => {
            ttsActive = false;
            if (typeof onEnd === 'function') onEnd();
          }
        });
      } else if ('speechSynthesis' in window) {
        ttsUtterance = new SpeechSynthesisUtterance(text);
        ttsUtterance.lang = 'da-DK';
        // Synkroniser stemmev√¶lger med browser voices
        let voices = window.speechSynthesis.getVoices();
        ttsUtterance.voice = voices.find(v => v.name === voiceName) || voices.find(v => v.lang.startsWith('da')) || null;
        ttsActive = true;
        ttsUtterance.onend = () => {
          ttsActive = false;
          if (typeof onEnd === 'function') onEnd();
        };
        window.speechSynthesis.speak(ttsUtterance);
      } else {
        if (typeof onEnd === 'function') onEnd();
      }
    }
    function stopTTS() {
      if ('speechSynthesis' in window) window.speechSynthesis.cancel();
      ttsUtterance = null;
      ttsActive = false;
    }
    // --- Controls ---
    stopBtn.onclick = () => {
      stopAll();
      scriptText.style.display = 'none';
      playerControls.style.display = 'none';
      document.getElementById('mainSelection').style.display = 'block';
      document.getElementById('backToCategoriesBtn').style.display = 'none';
    };
    pauseBtn.onclick = () => {
      if (!isPaused) {
        bgVideo.pause();
        audioTrack.pause();
        if ('speechSynthesis' in window) window.speechSynthesis.pause();
        pauseBtn.textContent = '‚ñ∂Ô∏è';
        isPaused = true;
        if (moduleTimeout) clearTimeout(moduleTimeout);
      } else {
        bgVideo.play();
        audioTrack.play();
        if ('speechSynthesis' in window) window.speechSynthesis.resume();
        pauseBtn.textContent = '‚è∏Ô∏è';
        isPaused = false;
        if (currentModule && currentModule.next) showModule(currentModule);
      }
    };
    // --- Voice selector init ---
    function populateVoices() {
      let voices = [];
      if (window.Tr√∏stMigTTS && Array.isArray(window.Tr√∏stMigTTS.voices)) {
        voices = window.Tr√∏stMigTTS.voices;
      } else if (window.speechSynthesis) {
        voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('da'));
      }
      [voiceSelector, document.getElementById('navVoiceSelector')].forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '';
        voices.forEach(v => {
          let opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = v.name;
          sel.appendChild(opt);
        });
      });
      let savedVoice = localStorage.getItem('preferredVoice');
      if (savedVoice) {
        if (voiceSelector) voiceSelector.value = savedVoice;
        if (document.getElementById('navVoiceSelector')) document.getElementById('navVoiceSelector').value = savedVoice;
      }
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = populateVoices;
      populateVoices();
    }
    [voiceSelector, document.getElementById('navVoiceSelector')].forEach(sel => {
      if (!sel) return;
      sel.onchange = function() {
        localStorage.setItem('preferredVoice', this.value);
        playTTS(currentModule ? currentModule.text : '');
      };
    });
    // --- Favorit og theme init ---
    updateFavBtn();
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
    }
    document.getElementById('themeToggle').onclick = function() {
      const html = document.documentElement;
      if (html.getAttribute('data-theme') === 'dark') {
        html.setAttribute('data-theme', 'light');
        this.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        this.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      }
    };
    // --- Stop alt hvis man forlader siden ---
    function stopAll() {
      bgVideo.pause();
      audioTrack.pause();
      stopTTS();
      isPaused = false;
      if (moduleTimeout) clearTimeout(moduleTimeout);
      pauseBtn.textContent = '‚è∏Ô∏è';
    }
    window.addEventListener('beforeunload', stopAll);
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) stopAll();
    });
  </script>
</body>
</html>
