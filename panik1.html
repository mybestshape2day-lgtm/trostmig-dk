<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulær Panik Session - TrøstMig.dk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(0, 0, 0, 0.4) 0%,
                rgba(0, 0, 0, 0.2) 50%,
                rgba(0, 0, 0, 0.6) 100%
            );
            z-index: 2;
        }
        
        .content-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 900px;
            z-index: 10;
            text-align: center;
        }
        
        .script-title {
            font-size: clamp(1.8rem, 4vw, 3rem);
            font-weight: 300;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 3rem;
            text-shadow: 0 2px 15px rgba(0, 0, 0, 0.9);
            opacity: 0;
            animation: fadeInTitle 2s ease-out 0.5s forwards;
            font-style: italic;
        }
        
        .text-display {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 8px rgba(0, 0, 0, 0.8);
            font-weight: 300;
            letter-spacing: 0.3px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .text-line {
            opacity: 0;
            transform: translateY(20px);
            transition: all 1.5s ease-out;
        }
        
        .text-line.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .text-line.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .pause-indicator {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* CHOICE OVERLAY - Forbedret interaktivt element */
        .choice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 25;
            backdrop-filter: blur(10px);
        }
        
        .choice-overlay.active {
            display: flex;
            animation: fadeIn 0.5s ease-out;
        }
        
        .choice-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            color: #2d3748;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .choice-container h3 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #1a202c;
            font-weight: 400;
        }
        
        .choice-buttons {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .choice-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1.1rem;
            color: #2d3748;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        
        .choice-btn:hover {
            border-color: #4a90e2;
            background: #f7fafc;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.15);
        }
        
        .choice-letter {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: #4a90e2;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .module-indicator {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 15;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .breathing-visual {
            position: absolute;
            top: 50%;
            right: 10%;
            transform: translateY(-50%);
            width: 120px;
            height: 120px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            transition: all 4s ease-in-out;
            z-index: 15;
        }
        
        .breathing-visual.active {
            display: flex;
        }
        
        .breathing-visual.inhale {
            transform: translateY(-50%) scale(1.3);
            background: rgba(74, 144, 226, 0.3);
            border-color: #4a90e2;
        }
        
        .breathing-visual.hold {
            background: rgba(123, 104, 238, 0.3);
            border-color: #7b68ee;
        }
        
        .breathing-visual.exhale {
            transform: translateY(-50%) scale(0.7);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .controls-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 2rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-radius: 50px;
            z-index: 20;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 4px;
            border-radius: 2px;
            width: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4a90e2, #7b68ee);
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .timing-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }
        
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 30;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-width: 300px;
            display: none;
        }
        
        .debug-panel.visible {
            display: block;
        }
        
        @keyframes fadeInTitle {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .content-overlay {
                width: 95%;
            }
            
            .controls-bar {
                flex-wrap: wrap;
                gap: 1rem;
                padding: 0.8rem 1.5rem;
            }
            
            .progress-bar {
                width: 200px;
            }
            
            .choice-container {
                padding: 25px;
            }
            
            .choice-btn {
                padding: 15px;
                font-size: 1rem;
            }
            
            .breathing-visual {
                right: 5%;
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Video/Gradient -->
    <div class="video-container">
        <div class="video-overlay"></div>
    </div>
    
    <!-- Content -->
    <div class="content-overlay">
        <!-- Module Indicator -->
        <div class="module-indicator" id="module-indicator">Session Start</div>
        
        <h1 class="script-title">En psykologs stemme i mørket</h1>
        
        <div class="text-display" id="text-display">
            <div class="text-line">Klik Start for at begynde sessionen</div>
        </div>
        
        <!-- Breathing Visual (vises kun under vejrtrækning) -->
        <div class="breathing-visual" id="breathing-visual"></div>
    </div>
    
    <!-- Choice Selection Overlay -->
    <div class="choice-overlay" id="choice-overlay">
        <div class="choice-container">
            <h3 id="choice-question">Hvad har du mest brug for lige nu?</h3>
            <div class="choice-buttons" id="choice-buttons">
                <!-- Populated by JavaScript -->
            </div>
            <p style="font-size: 0.9rem; color: #718096; margin-top: 20px;">
                Du kan altid vende tilbage og vælge noget andet
            </p>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls-bar">
        <button class="control-btn" onclick="startTest()" id="start-btn">▶ Start Session</button>
        <button class="control-btn" onclick="pauseTest()" id="pause-btn">⏸ Pause</button>
        <button class="control-btn" onclick="resetTest()" id="reset-btn">🔄 Reset</button>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="timing-info" id="timing-info">0:00 / 0:00</div>
        <button class="control-btn" onclick="toggleDebug()" id="debug-btn">🐛</button>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <h4>Debug Info:</h4>
        <div>Current Module: <span id="current-module-debug">intro</span></div>
        <div>Audio Time: <span id="audio-time">0.00</span>s</div>
        <div>Current Segment: <span id="current-segment">-</span></div>
        <div>Next Cue: <span id="next-cue">-</span></div>
        <div>Status: <span id="status">Ready</span></div>
    </div>
    
    <!-- Audio -->
    <audio id="audio-player" preload="auto">
        <!-- Audio source will be loaded dynamically -->
    </audio>
    
    <script>
        // FORBEDRET MODULÆRT SCRIPT SYSTEM
        const scriptDatabase = {
            // INTRO - Rammesætning & Normalisering
            intro: [
                {
                    time: 0.0,
                    text: "Goddag. Mit navn er doktor Nielsen. Jeg har arbejdet med panikangst i over tyve år.",
                    duration: 6.0
                },
                {
                    time: 6.5,
                    text: "[pause - rolig åndedræt]",
                    duration: 2.0,
                    isPause: true
                },
                {
                    time: 9.0,
                    text: "Hvis du lytter til dette lige nu... så ved jeg, at du har det svært.",
                    duration: 6.0
                },
                {
                    time: 15.5,
                    text: "Måske banker dit hjerte. Måske kan du ikke få luft. Måske føles alt uvirkeligt.",
                    duration: 7.0
                },
                {
                    time: 23.0,
                    text: "Jeg vil sige noget vigtigt: Du er IKKE ved at dø. Du er IKKE ved at miste forstanden.",
                    duration: 7.0
                },
                {
                    time: 30.5,
                    text: "Det du oplever er panikangst. Det er ubehageligt - forfærdeligt endda - men det er IKKE farligt.",
                    duration: 8.0
                },
                {
                    time: 39.0,
                    text: "Jeg vil nu give dig nogle valgmuligheder for, hvordan vi kan hjælpe dig lige nu.",
                    duration: 5.0,
                    hasChoices: true,
                    choices: [
                        { id: 'acute_relief', text: 'A) Akut lindring - stop panikken NU' },
                        { id: 'understand_panic', text: 'B) Forstå hvad der sker i min krop' },
                        { id: 'cbt_techniques', text: 'C) Kognitive teknikker (tankearbejde)' },
                        { id: 'breathing_exercises', text: 'D) Guidet vejrtrækning' },
                        { id: 'complete_session', text: 'E) Komplet session (alt sammen)' }
                    ]
                }
            ],
            
            // AKUT LINDRING - Øjeblikkelig hjælp
            acute_relief: [
                {
                    time: 0.0,
                    text: "Okay. Vi stopper panikken sammen. Lige nu.",
                    duration: 4.0
                },
                {
                    time: 4.5,
                    text: "Find noget rødt i rummet. Kig på det. Beskriv det for dig selv.",
                    duration: 6.0
                },
                {
                    time: 11.0,
                    text: "[pause - lad personen finde noget rødt]",
                    duration: 4.0,
                    isPause: true
                },
                {
                    time: 15.5,
                    text: "Nu finder du noget blåt. Fokuser på det. Hvilken nuance af blå er det?",
                    duration: 6.0
                },
                {
                    time: 22.0,
                    text: "Dette hedder grounding. Vi bringer din hjerne tilbage til nuet, væk fra panikken.",
                    duration: 6.0
                },
                {
                    time: 28.5,
                    text: "Læg nu en hånd på dit bryst, en på maven. Mærk hvilken der bevæger sig mest.",
                    duration: 7.0
                },
                {
                    time: 36.0,
                    text: "Vi skal have maven til at bevæge sig. Indånd gennem næsen... og ud gennem munden.",
                    duration: 7.0,
                    isBreathingExercise: true,
                    breathingPhase: 'inhale'
                },
                {
                    time: 43.5,
                    text: "Panikken topper altid inden for 10 minutter. ALTID. Du er måske allerede over toppen.",
                    duration: 7.0
                },
                {
                    time: 51.0,
                    text: "Vil du høre mere om hvad der sker i din krop, eller skal vi fortsætte med beroligelse?",
                    duration: 5.0,
                    hasChoices: true,
                    choices: [
                        { id: 'understand_panic', text: 'Forklar hvad der sker i kroppen' },
                        { id: 'breathing_exercises', text: 'Mere vejrtrækning' },
                        { id: 'cbt_techniques', text: 'Arbejd med tankerne' }
                    ]
                }
            ],
            
            // FORSTÅ PANIK - Psykoedukation
            understand_panic: [
                {
                    time: 0.0,
                    text: "Lad mig forklare præcis hvad der sker i din krop lige nu.",
                    duration: 5.0
                },
                {
                    time: 5.5,
                    text: "Din amygdala - hjernens alarmcentral - har aktiveret et falsk alarm.",
                    duration: 6.0
                },
                {
                    time: 12.0,
                    text: "Kroppen tror der er fare og pumper adrenalin ud. Derfor banker hjertet.",
                    duration: 6.0
                },
                {
                    time: 18.5,
                    text: "Du hyperventilerer - ånder for hurtigt. Det ændrer CO2 i blodet. Derfor svimmelhed.",
                    duration: 7.0
                },
                {
                    time: 26.0,
                    text: "Musklerne spænder. Blodet går til de store muskler. Derfor prikken og følelsesløshed.",
                    duration: 7.0
                },
                {
                    time: 33.5,
                    text: "Alt dette er NORMALT ved panik. Ubehageligt - ja. Farligt - NEJ.",
                    duration: 6.0
                },
                {
                    time: 40.0,
                    text: "Ingen er NOGENSINDE død af panikangst. Hjertet kan sagtens klare det.",
                    duration: 6.0
                },
                {
                    time: 46.5,
                    text: "Forskning viser: 70% får det markant bedre med terapi. Panikangst KAN behandles.",
                    duration: 7.0
                },
                {
                    time: 54.0,
                    text: "Hvad vil du gerne nu?",
                    duration: 3.0,
                    hasChoices: true,
                    choices: [
                        { id: 'cbt_techniques', text: 'Lær at udfordre paniktankerne' },
                        { id: 'breathing_exercises', text: 'Prøv vejrtrækningsøvelser' },
                        { id: 'act_acceptance', text: 'Accept-baseret tilgang (ACT)' }
                    ]
                }
            ],
            
            // CBT TEKNIKKER - Kognitivt arbejde
            cbt_techniques: [
                {
                    time: 0.0,
                    text: "Nu arbejder vi med tankerne. Panikangst næres af katastrofetanker.",
                    duration: 6.0
                },
                {
                    time: 6.5,
                    text: "Hvad er din værste tanke lige nu? 'Jeg dør'? 'Jeg mister kontrollen'?",
                    duration: 6.0
                },
                {
                    time: 13.0,
                    text: "[pause - lad personen identificere tanken]",
                    duration: 3.0,
                    isPause: true
                },
                {
                    time: 16.5,
                    text: "Lad os teste denne tanke. Hvor mange gange har du troet du skulle dø af panik?",
                    duration: 6.0
                },
                {
                    time: 23.0,
                    text: "Og hvor mange gange ER du død? Nul. Tankens forudsigelse holder ikke.",
                    duration: 6.0
                },
                {
                    time: 29.5,
                    text: "Vi kalder det 'kognitiv forvrængning'. Hjernen overdriver fare.",
                    duration: 6.0
                },
                {
                    time: 36.0,
                    text: "Ny tanke: 'Dette er ubehageligt, men jeg overlever. Jeg har gjort det før.'",
                    duration: 7.0
                },
                {
                    time: 43.5,
                    text: "Gentag denne tanke for dig selv nu.",
                    duration: 4.0
                },
                {
                    time: 48.0,
                    text: "[pause - lad personen gentage]",
                    duration: 4.0,
                    isPause: true
                },
                {
                    time: 52.5,
                    text: "Hver gang du udfordrer katastrofetanken, svækkes panikangstens greb.",
                    duration: 6.0
                }
            ],
            
            // VEJRTRÆKNING - 4-7-8 teknik
            breathing_exercises: [
                {
                    time: 0.0,
                    text: "Vi laver nu 4-7-8 vejrtrækning. Evidensbaseret og effektiv mod panik.",
                    duration: 6.0
                },
                {
                    time: 6.5,
                    text: "Pust al luften ud først. Tøm lungerne helt.",
                    duration: 5.0,
                    isBreathingExercise: true,
                    breathingPhase: 'exhale'
                },
                {
                    time: 12.0,
                    text: "Indånd gennem næsen og tæl: 1... 2... 3... 4...",
                    duration: 5.0,
                    isBreathingExercise: true,
                    breathingPhase: 'inhale'
                },
                {
                    time: 17.5,
                    text: "Hold vejret: 1... 2... 3... 4... 5... 6... 7...",
                    duration: 8.0,
                    isBreathingExercise: true,
                    breathingPhase: 'hold'
                },
                {
                    time: 26.0,
                    text: "Udånd gennem munden: 1... 2... 3... 4... 5... 6... 7... 8...",
                    duration: 9.0,
                    isBreathingExercise: true,
                    breathingPhase: 'exhale'
                },
                {
                    time: 35.5,
                    text: "Godt. Mærk hvordan kroppen allerede er mere rolig.",
                    duration: 5.0
                },
                {
                    time: 41.0,
                    text: "Vi gør det igen. Indånd 1... 2... 3... 4...",
                    duration: 5.0,
                    isBreathingExercise: true,
                    breathingPhase: 'inhale'
                },
                {
                    time: 46.5,
                    text: "Hold: 1... 2... 3... 4... 5... 6... 7...",
                    duration: 8.0,
                    isBreathingExercise: true,
                    breathingPhase: 'hold'
                },
                {
                    time: 55.0,
                    text: "Ud: 1... 2... 3... 4... 5... 6... 7... 8...",
                    duration: 9.0,
                    isBreathingExercise: true,
                    breathingPhase: 'exhale'
                },
                {
                    time: 64.5,
                    text: "Dette aktiverer din parasympatiske nervesystem. Kroppens egen beroligelse.",
                    duration: 6.0
                }
            ],
            
            // ACT - Accept og værdier
            act_acceptance: [
                {
                    time: 0.0,
                    text: "Lad os prøve noget andet. I stedet for at kæmpe mod angsten - inviter den indenfor.",
                    duration: 7.0
                },
                {
                    time: 7.5,
                    text: "Sig til angsten: 'Hej angst. Jeg ser dig. Du må gerne være her.'",
                    duration: 6.0
                },
                {
                    time: 14.0,
                    text: "Dette lyder kontraintuitivt, men modstand forstærker panikken.",
                    duration: 6.0
                },
                {
                    time: 20.5,
                    text: "Forestil dig angsten som en bølge. Du surfer på den, i stedet for at drukne i den.",
                    duration: 7.0
                },
                {
                    time: 28.0,
                    text: "Hvad er vigtigt for dig i livet? Familie? Arbejde? Kreativitet?",
                    duration: 6.0
                },
                {
                    time: 34.5,
                    text: "[pause - lad personen tænke]",
                    duration: 4.0,
                    isPause: true
                },
                {
                    time: 39.0,
                    text: "Kan du tage et lille skridt mod det vigtige - SELVOM angsten er her?",
                    duration: 6.0
                },
                {
                    time: 45.5,
                    text: "Dette er ACT - Acceptance and Commitment Therapy. Lev dit liv, med plads til angst.",
                    duration: 7.0
                },
                {
                    time: 53.0,
                    text: "Angsten bliver mindre, når den ikke længere bestemmer dine handlinger.",
                    duration: 6.0
                }
            ],
            
            // KOMPLET SESSION
            complete_session: [
                {
                    time: 0.0,
                    text: "Vi kører hele programmet. 15 minutter der kan ændre din dag.",
                    duration: 5.0
                },
                {
                    time: 5.5,
                    text: "Først: Du er sikker. Jeg er her hele vejen.",
                    duration: 4.0
                },
                // ... Her ville den komplette session fortsætte
                {
                    time: 10.0,
                    text: "Sessionen fortsætter med alle elementer...",
                    duration: 5.0
                }
            ]
        };
        
        // Current session state
        let currentModule = 'intro';
        let scriptSegments = scriptDatabase[currentModule];
        let currentSegmentIndex = 0;
        let isPlaying = false;
        let animationFrame;
        let audio = document.getElementById('audio-player');
        
        // Elements
        const textDisplay = document.getElementById('text-display');
        const progressFill = document.getElementById('progress-fill');
        const timingInfo = document.getElementById('timing-info');
        const debugPanel = document.getElementById('debug-panel');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧠 Modulær Panik Session loaded');
            console.log('Tilgængelige moduler:', Object.keys(scriptDatabase));
            
            // Placeholder for audio - in production this would load actual audio
            console.log('Audio system ready (TTS would connect here)');
            
            updateModuleIndicator(currentModule);
        });
        
        function startTest() {
            if (!isPlaying) {
                console.log('Starting session with module:', currentModule);
                isPlaying = true;
                
                // Start animation loop (audio would be synced here)
                animationFrame = requestAnimationFrame(updateTextDisplay);
                
                // Update UI
                document.getElementById('start-btn').textContent = '▶ Playing...';
                document.getElementById('status').textContent = 'Playing';
                
                console.log('Session started');
            }
        }
        
        function pauseTest() {
            if (isPlaying) {
                isPlaying = false;
                cancelAnimationFrame(animationFrame);
                
                document.getElementById('start-btn').textContent = '▶ Resume';
                document.getElementById('status').textContent = 'Paused';
                
                console.log('Session paused');
            } else {
                // Resume
                isPlaying = true;
                animationFrame = requestAnimationFrame(updateTextDisplay);
                
                document.getElementById('start-btn').textContent = '▶ Playing...';
                document.getElementById('status').textContent = 'Playing';
            }
        }
        
        function resetTest() {
            isPlaying = false;
            currentSegmentIndex = 0;
            currentModule = 'intro';
            scriptSegments = scriptDatabase[currentModule];
            cancelAnimationFrame(animationFrame);
            
            // Reset UI
            textDisplay.innerHTML = '<div class="text-line">Klik Start for at begynde sessionen</div>';
            progressFill.style.width = '0%';
            document.getElementById('start-btn').textContent = '▶ Start Session';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('choice-overlay').classList.remove('active');
            
            updateModuleIndicator(currentModule);
            updateTimingInfo();
            updateDebugInfo();
            
            console.log('Session reset');
        }
        
        // Simulated timing for demo
        let simulatedTime = 0;
        let lastTimestamp = 0;
        
        function updateTextDisplay(timestamp) {
            if (!isPlaying) return;
            
            // Simulate timing
            if (!lastTimestamp) lastTimestamp = timestamp;
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            simulatedTime += deltaTime / 1000; // Convert to seconds
            
            const currentSegment = scriptSegments[currentSegmentIndex];
            
            // Check if we should move to next segment
            if (currentSegment && simulatedTime >= currentSegment.time) {
                // Handle choices
                if (currentSegment.hasChoices) {
                    showChoiceOverlay(currentSegment.choices, currentSegment.text);
                    pauseTest();
                    return;
                }
                
                // Handle breathing exercises
                if (currentSegment.isBreathingExercise) {
                    showBreathingVisual(currentSegment.breathingPhase);
                }
                
                showTextSegment(currentSegment);
                currentSegmentIndex++;
                
                // Check if module is complete
                if (currentSegmentIndex >= scriptSegments.length) {
                    console.log('Module complete, showing final choices');
                    showFinalChoices();
                    pauseTest();
                    return;
                }
            }
            
            // Update progress (simulated)
            const totalDuration = 70; // Approximate duration
            const progress = (simulatedTime / totalDuration) * 100;
            progressFill.style.width = Math.min(progress, 100) + '%';
            
            updateTimingInfo();
            updateDebugInfo();
            
            if (isPlaying) {
                animationFrame = requestAnimationFrame(updateTextDisplay);
            }
        }
        
        // Enhanced choice system
        function showChoiceOverlay(choices, questionText = "Hvad har du mest brug for lige nu?") {
            const overlay = document.getElementById('choice-overlay');
            const questionEl = document.getElementById('choice-question');
            const buttonsContainer = document.getElementById('choice-buttons');
            
            questionEl.textContent = questionText || "Hvad vil du gerne høre mere om?";
            
            let buttonsHTML = '';
            choices.forEach(choice => {
                buttonsHTML += `
                    <button class="choice-btn" onclick="selectChoice('${choice.id}')">
                        <span class="choice-letter">${choice.text.charAt(0)}</span>
                        ${choice.text.substring(3)}
                    </button>
                `;
            });
            
            buttonsContainer.innerHTML = buttonsHTML;
            overlay.classList.add('active');
            
            console.log('Showing choice overlay with options:', choices.map(c => c.id));
        }
        
        function showFinalChoices() {
            const choices = [
                { id: 'intro', text: 'A) Start forfra' },
                { id: 'acute_relief', text: 'B) Akut lindring' },
                { id: 'breathing_exercises', text: 'C) Mere vejrtrækning' },
                { id: 'cbt_techniques', text: 'D) Arbejd med tanker' }
            ];
            showChoiceOverlay(choices, "Sessionen er slut. Vil du prøve noget andet?");
        }
        
        function selectChoice(choiceId) {
            const overlay = document.getElementById('choice-overlay');
            overlay.classList.remove('active');
            
            // Load new module
            loadModule(choiceId);
            
            console.log(`User selected: ${choiceId}`);
        }
        
        function loadModule(moduleId) {
            if (!scriptDatabase[moduleId]) {
                console.error('Module not found:', moduleId);
                return;
            }
            
            currentModule = moduleId;
            scriptSegments = scriptDatabase[moduleId];
            currentSegmentIndex = 0;
            simulatedTime = 0;
            lastTimestamp = 0;
            
            // Update module indicator
            updateModuleIndicator(moduleId);
            
            // Resume playback
            setTimeout(() => {
                startTest();
            }, 500);
            
            console.log(`Loaded module: ${moduleId}`);
        }
        
        function updateModuleIndicator(moduleId) {
            const indicators = {
                'intro': '🎯 Introduktion',
                'acute_relief': '🆘 Akut Lindring',
                'understand_panic': '🧠 Forstå Panik',
                'cbt_techniques': '💭 Kognitive Teknikker',
                'breathing_exercises': '🌬️ Vejrtrækning',
                'act_acceptance': '🌊 Accept (ACT)',
                'complete_session': '📚 Komplet Session'
            };
            
            const indicator = document.getElementById('module-indicator');
            indicator.textContent = indicators[moduleId] || moduleId;
        }
        
        function showBreathingVisual(phase) {
            const visual = document.getElementById('breathing-visual');
            
            // Remove old classes
            visual.classList.remove('inhale', 'hold', 'exhale');
            
            // Add phase class and show
            visual.classList.add('active', phase);
            
            if (phase === 'inhale') {
                visual.textContent = 'Indånd';
            } else if (phase === 'hold') {
                visual.textContent = 'Hold';
            } else if (phase === 'exhale') {
                visual.textContent = 'Udånd';
            }
            
            // Auto-hide after duration
            setTimeout(() => {
                visual.classList.remove('active', 'inhale', 'hold', 'exhale');
            }, 4000);
        }
        
        function showTextSegment(segment) {
            console.log('Showing segment:', segment.text.substring(0, 50) + '...');
            
            if (segment.isPause) {
                textDisplay.innerHTML = `<div class="text-line visible pause-indicator">${segment.text}</div>`;
            } else {
                textDisplay.innerHTML = `<div class="text-line visible">${segment.text}</div>`;
            }
            
            // Auto-fade after duration
            if (segment.duration) {
                setTimeout(() => {
                    const currentLine = textDisplay.querySelector('.text-line');
                    if (currentLine) {
                        currentLine.classList.add('fade-out');
                    }
                }, (segment.duration - 1) * 1000);
            }
        }
        
        function updateTimingInfo() {
            const current = formatTime(simulatedTime);
            const total = formatTime(70); // Approximate total
            timingInfo.textContent = `${current} / ${total}`;
        }
        
        function updateDebugInfo() {
            document.getElementById('current-module-debug').textContent = currentModule;
            document.getElementById('audio-time').textContent = simulatedTime.toFixed(2);
            document.getElementById('current-segment').textContent = currentSegmentIndex;
            
            const nextSegment = scriptSegments[currentSegmentIndex];
            if (nextSegment) {
                document.getElementById('next-cue').textContent = 
                    `${nextSegment.time}s: ${nextSegment.text.substring(0, 30)}...`;
            } else {
                document.getElementById('next-cue').textContent = 'End of module';
            }
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function toggleDebug() {
            debugPanel.classList.toggle('visible');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (isPlaying) {
                        pauseTest();
                    } else {
                        startTest();
                    }
                    break;
                case 'KeyR':
                    e.preventDefault();
                    resetTest();
                    break;
                case 'KeyD':
                    e.preventDefault();
                    toggleDebug();
                    break;
            }
        });
        
        console.log('🎭 Enhanced Modular Panic System Ready');
        console.log('Space = Play/Pause | R = Reset | D = Debug');
    </script>
</body>
</html>